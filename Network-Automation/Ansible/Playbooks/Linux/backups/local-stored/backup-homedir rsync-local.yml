---
- name: Backup home directory data from VMs
  hosts: '*'
  gather_facts: true
  become: true

  vars:
    backup_dir: "/backups"
    source_dir: "/home/austin"
    dest_dir: "{{ backup_dir }}/{{ inventory_hostname }}-{{ ansible_date_time.date }}-backup"
    rsync_excludes: "backups"

  tasks:
    - name: Ensure rsync is installed
      apt:
        name: rsync
        state: present
      delegate_to: localhost # run this on Ansible controller

    - name: Create backup directory
      file:
        path: "{{ dest_dir }}"
        state: directory
      delegate_to: localhost # run this on Ansible controller

    - name: Backup data
      shell: "rsync -az --exclude={{ rsync_excludes }} {{ ansible_user }}@{{ inventory_hostname }}:{{ source_dir }}/ {{ dest_dir }}/."
      delegate_to: localhost # run this on Ansible controller

    - name: Verify backup
      stat:
        path: "{{ dest_dir }}"
      register: backup_stats
      delegate_to: localhost # run this on Ansible controller

    - name: Print backup status
      debug:
        msg: "Backup successful: {{ backup_stats.stat.exists }}"
      delegate_to: localhost # run this on Ansible controller
